<!DOCTYPE html>
<html>
<head>
  <title><%= user.nickname %>ì˜ ëª¨í—˜</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <h1>ğŸŒŸ <%= user.nickname %>ì˜ ëª¨í—˜</h1>

  <p>ìœ„ì¹˜: <strong><%= user.currentLocation %></strong></p>
  <p>ë ˆë²¨: <span id="level"><%= user.level %></span> | ê²½í—˜ì¹˜: <span id="exp"><%= user.exp %></span></p>

  <!-- HPì™€ MP í‘œì‹œ -->
  <p>HP: <span id="hp"><%= user.hp %></span> | MP: <span id="mp"><%= user.mp %></span></p>
  
  <!-- ë‹¨ìˆœí™”ëœ ê³µê²©ë ¥ê³¼ ë°©ì–´ë ¥ í‘œì‹œ -->
<!-- ê³µê²©ë ¥ / ë°©ì–´ë ¥ ì¶œë ¥ -->
<p>
  ğŸ”¥ ATK: <span id="atk"><%= typeof bonus.atk !== 'undefined' ? bonus.atk : 0 %></span>
  | ğŸ›¡ï¸ DEF: <span id="def"><%= typeof bonus.def !== 'undefined' ? bonus.def : 0 %></span>
</p>



  <p>í˜„ì¬ ì§€ì—­: <span id="currentLocation"><%= user.currentLocation %></span></p>

  <script>
  async function fetchStatus() {
    const res = await fetch('/status');
    const data = await res.json();

    document.getElementById('level').textContent = data.level;
    document.getElementById('exp').textContent = data.exp;
    document.getElementById('hp').textContent = data.hp;
    document.getElementById('mp').textContent = data.mp;

    // âœ… ì˜ëª»ëœ ë¶€ë¶„ ìˆ˜ì •!
    document.getElementById('atk').textContent = data.bonus.atk;
    document.getElementById('def').textContent = data.bonus.def;
  }

  fetchStatus();
</script>

      
      // ì „íˆ¬ ë¡œê·¸ ì—…ë°ì´íŠ¸
      const battleLogList = document.getElementById('battleLog');
      if (battleLogList && data.battleLogs) {
        battleLogList.innerHTML = '';
        data.battleLogs.forEach(log => {
          const li = document.createElement('li');
          li.textContent = log;
          battleLogList.appendChild(li);
        });
      }
    }

    setInterval(fetchStatus, 5000); // 5ì´ˆë§ˆë‹¤ ìƒíƒœ ê°±ì‹ 
    fetchStatus(); // ìµœì´ˆ 1íšŒ ì‹¤í–‰
  </script>

  <p>ì¥ë¹„:
    <br>ë¬´ê¸°: <%= user.equipped.weapon ? user.equipped.weapon.name : 'ì—†ìŒ' %>
    <br>ë°©ì–´êµ¬: <%= user.equipped.armor ? user.equipped.armor.name : 'ì—†ìŒ' %>
    <br>ì¥ì‹ êµ¬: <%= user.equipped.accessory ? user.equipped.accessory.name : 'ì—†ìŒ' %>
  </p>

  <h2>âš”ï¸ ì‚¬ëƒ¥</h2>

  <% if (['field', 'forest', 'dungeon', 'volcano', 'icecave', 'ruins', 'skyisland'].includes(user.currentLocation)) { %>
    <% if (user.isAutoHunting) { %>
      <p style="color: lightgreen;">ìë™ì‚¬ëƒ¥ ì¤‘ì…ë‹ˆë‹¤! ğŸ”</p>
      <form method="POST" action="/battle/stop">
        <button type="submit">â›” ë©ˆì¶¤</button>
      </form>
    <% } else { %>
      <form method="POST" action="/battle/start">
        <button type="submit">â–¶ï¸ ì‚¬ëƒ¥ ì‹œì‘</button>
      </form>
    <% } %>
  <% } else { %>
    <p style="color: gray;">âš ï¸ ì´ ì§€ì—­ì—ì„œëŠ” ì‚¬ëƒ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
  <% } %>

  <hr />

  <script>
    function useInn() {
      fetch('/inn', { method: 'POST' })
        .then(() => location.reload());
    }
  </script>

  <p>
    <a href="/inventory">ğŸ’ ì¸ë²¤í† ë¦¬</a> |
    <a href="/shop">ğŸ›’ ìƒì </a> |
    <a href="/inn">ğŸ¨ ì—¬ê´€</a> |
    <a href="/jobchange">ğŸ” ì „ì§</a> |
    <a href="/map">ğŸ§­ ì§€ì—­ ì´ë™</a> |
    <a href="#" onclick="togglePlaza()">ğŸ“œ ë°©ëª…ë¡</a> |
    <a href="/logout">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
  </p>

  <hr />
  <h3>âš”ï¸ ì „íˆ¬ ë¡œê·¸</h3>
  <ul id="battleLog" style="color:orange;"></ul>

  <h3>ğŸ“œ ì‹œìŠ¤í…œ ë©”ì‹œì§€</h3>
  <ul id="messageList"></ul>

  <div id="plazaBox" style="display:none; position:fixed; top:100px; left:50%; transform:translateX(-50%); width:400px; background:#222; color:#fff; border:1px solid #555; padding:10px; z-index:1000;">
    <h4>ğŸ“œ ë§ˆì„ ê´‘ì¥ ë°©ëª…ë¡</h4>
    <form id="plazaForm">
      <input type="text" name="message" id="plazaInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width:70%;" required />
      <button type="submit">ë“±ë¡</button>
    </form>
    <ul id="plaza-messages" style="max-height:200px; overflow:auto; margin-top:10px;"></ul>
    <button onclick="togglePlaza()">ë‹«ê¸°</button>
  </div>

  <script>
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ìë™ì‚¬ëƒ¥ ë¡œê·¸ ë“±)
    async function fetchMessages() {
      const res = await fetch('/messages/latest');
      const data = await res.json();
      const ul = document.getElementById('messageList');
      ul.innerHTML = '';
      data.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        ul.appendChild(li);
      });
    }

    // ë°©ëª…ë¡ í¼ ë¹„ë™ê¸° ì „ì†¡
    document.getElementById('plazaForm').addEventListener('submit', async function (e) {
      e.preventDefault(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
      const input = document.getElementById('plazaInput');
      const msg = input.value.trim();
      if (!msg) return;

      await fetch('/plaza/post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message: msg })
      });

      input.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
      loadPlazaMessages(); // ë©”ì‹œì§€ ê°±ì‹ 
    });

    // ë°©ëª…ë¡ UI í† ê¸€
    function togglePlaza() {
      const box = document.getElementById('plazaBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    // ë°©ëª…ë¡ ë©”ì‹œì§€ ê°±ì‹ 
    async function loadPlazaMessages() {
      const res = await fetch('/plaza/messages');
      const data = await res.json();
      const ul = document.getElementById('plaza-messages');
      ul.innerHTML = '';
      data.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        ul.appendChild(li);
      });
    }

    // 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
    setInterval(fetchMessages, 5000);
    setInterval(loadPlazaMessages, 5000);
    fetchMessages();
    loadPlazaMessages();
  </script>

</body>
</html>
